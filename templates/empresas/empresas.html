<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Proveedor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../static/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>



/* Botones */
.btn {
  padding: 8px 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s;
  margin-bottom: 10px; /* üëà margen inferior agregado */
}

.btn-primary {
  background-color: #007bff;
  color: white;
}

.btn-primary:hover {
  background-color: #0056b3;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
}

.btn-secondary:hover {
  background-color: #545b62;
}

.btn-outline {
  border: 1px solid #007bff;
  background-color: transparent;
  color: #007bff;
  padding: 6px 12px;
  border-radius: 4px;
  text-decoration: none;
}

.btn-outline:hover {
  background-color: #007bff;
  color: white;
}



/* Estado oculto */
.hidden {
  display: none !important;
}

/* Modal base */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  display: none;
  width: 100vw;
  height: 100vh;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

/* Mostrar el modal */
.modal.show {
  display: flex;
}

/* Contenido del modal */
.modal-content {
  background: white;
  padding: 30px;
  border-radius: 10px;
  min-width: 300px;
  max-width: 400px;
  box-shadow: 0px 0px 15px rgba(0,0,0,0.3);
  position: relative;
}
.modal-content h3 {
  margin-bottom: 20px;
}

.modal-content label {
  display: block;
  margin-top: 10px;
  font-weight: 500;
}

.modal-content input[type="text"],
.modal-content input[type="email"],
.modal-content input[type="file"] {
  width: 100%;
  margin-top: 5px;
  padding: 8px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

.close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}


td ul {
  list-style-type: none; /* opcional, saca los puntos */
  padding-left: 0;
  margin: 0;
}

td li {
  display: block; /* fuerza a que cada √≠tem est√© en su propia l√≠nea */
  margin-bottom: 4px; /* opcional, espacio entre formularios */
}

.mensaje-exito {
  color: green;
  margin-top: 10px;
  font-weight: bold;
}

.menu-item{
  cursor: pointer;
}
    </style>

</head>

<body>
  <div class="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <img src="../../static/media/logoLv.png" class="logo-grande" width="150" height="70" alt="logo linking value" />
      </div>
      <div class="sidebar-menu">
        <p class="menu-title">Navegaci√≥n</p>
        <a href="#" class="menu-item active">
          <i class="fas fa-home"></i>
          <span>Proveedor</span>
        </a>
        <a href="#" class="menu-item">
          <i class="fas fa-bell"></i>
          <span>Notificaciones</span>
        </a>
        <a href="#" class="menu-item">
          <i class="fas fa-cog"></i>
          <span>Configuraci√≥n</span>
        </a>

        <p class="menu-title">Empresa</p>
        <a href="#" class="menu-item">
          <i class="fas fa-building"></i>
          <span>Informaci√≥n</span>
        </a>
        <a href="#" class="menu-item">
          <i class="fas fa-question-circle"></i>
          <span>Soporte</span>
        </a>
        <a id="logoutBtn" class="menu-item"><i class="fas fa-sign-out-alt"></i><span>Cerrar sesi√≥n</span></a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <h1>Dashboard de Proveedor</h1>
        <div class="user-profile">
          <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User">
          <div class="user-info">
            <h4>Maria Garc√≠a</h4>
            <p>Proveedor de Acme Corp</p>
          </div>
        </div>
      </div>

      <!-- Welcome Banner -->
      <div class="welcome-banner">
        <div class="welcome-text">
          <h2>Formularios de Cumplimiento</h2>
          <p>Complete los formularios requeridos por su empresa cliente para mantener su relaci√≥n comercial
            activa.</p>
        </div>
        <div>
          <button class="btn btn-white">
            <i class="fas fa-question-circle"></i> Ayuda
          </button>
        </div>
      </div>



      <!-- Botones de acci√≥n -->
    <div class="table-actions">
      <button class="btn btn-primary" onclick="abrirModalAgregar()">
        <i class="fas fa-plus"></i> Agregar Proveedor
      </button>
      <button class="btn btn-secondary" onclick="abrirModalExcel()">
        <i class="fas fa-file-excel"></i> Cargar con Excel
      </button>
    </div>



    <!-- Modal Agregar Proveedor -->
<div id="modalAgregar" class="hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalAgregar()">&times;</span>
    <h3>Agregar nuevo proveedor</h3>
    <label>Nombre del proveedor:</label>
    <input type="text" id="nombreProveedor" placeholder="Ej: Juan P√©rez S.A.">
    <label>Email de contacto:</label>
    <input type="email" id="emailProveedor" placeholder="Ej: contacto@empresa.com">
     <div id="mensajeExito" class="mensaje-exito hidden">Proveedor guardado correctamente</div>
    <button class="btn btn-primary" onclick="guardarProveedor()">Guardar</button>
  </div>
</div>




    <!-- Modal Excel -->
<div id="modalExcel" class="hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalExcel()">&times;</span>
    <h3>Cargar proveedores desde Excel</h3>
    <p>¬øTen√©s la plantilla de Excel?</p>
    <div style="margin-top: 10px;">
      <a href="../../static/plantilla/plantilla_proveedores.xlsx" download class="btn btn-outline">Descargar plantilla</a>
    </div>
    <input type="file" accept=".xlsx" id="archivoExcel" />
    <button class="btn btn-primary" onclick="subirExcel()">Subir archivo</button>
  </div>
</div>







      <!-- Companies Table -->
      <div class="companies-container">
        <div class="table-header">
          <h3>Proveedores Registrados</h3>
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="buscador" placeholder="Buscar empresa..." />
          </div>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Proveedor</th>
              <th>Email</th>
              <th>Estado de Formularios</th>
            </tr>
          </thead>
          <tbody  id="proveedoresContainer"></tbody>
        </table>
      </div>

      <!-- Topics Grid
      <div class="topics-container" id="proveedoresContainer">
      Proveedores se insertar√°n aqu√≠ din√°micamente 
      </div> -->
    </div>
  </div>
  <script src="../../../src/script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {


    function verificarAcceso() {
        const usuario = localStorage.getItem("usuarioLogueado");
        if (!usuario || usuario != 'empresa') {
          alert("No tienes acceso. Inici√° sesi√≥n.");
          window.location.href = "../../index.html";
        }
      }

      verificarAcceso(); // ejecutar al inicio de cada p√°gina privada



        const idCliente = localStorage.getItem("idCliente");
       
        fetch(`http://localhost:8000/clientes/${idCliente}/terceros`)                     
        .then(res => {
          if (!res.ok) throw new Error("Error al obtener info del cliente");
          return res.json();
        })
        .then(data => {
          const container = document.getElementById("proveedoresContainer");
          container.innerHTML = "";

          try {
            data.forEach(p => {
              agregarTerceroTabla(p);
            });
          } catch (error) {
            container.innerHTML = "<p>Error al cargar los proveedores.</p>";
            console.error(error);
          }
        })
        .catch(err => {
          console.error("Error:", err);
        });




  const inputArchivo = document.getElementById("archivoExcel");
  inputArchivo.addEventListener("change", async (event) => {


  const archivo = inputArchivo.files[0];

  if (!archivo) {
    alert("Por favor, seleccion√° un archivo.");
    return;
  }

  // Validaciones
  if (archivo.size > 10 * 1024 * 1024) {
    alert("El archivo supera los 10MB.");
    inputArchivo.value = "";
    return;
  }

  if (archivo.type !== "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") {
    alert("Solo se permite un archivo .xlsx (Excel).");
    inputArchivo.value = "";
    return;
  }

  // Enviar archivo al backend
  const formData = new FormData();
  formData.append("archivo", archivo);

  try {
    const res = await fetch("http://localhost:8000/validar-archivo", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (res.ok && data.aprobado) {
      alert("Archivo Excel validado correctamente.");
      // Aqu√≠ podr√≠as continuar con la carga de datos o cerrar el modal
      //cerrarModalExcel(); // o lo que desees
    } else {
      alert(`Archivo rechazado: ${data.detalle || "Motivo desconocido"}`);
      inputArchivo.value = "";
    }
  } catch (error) {
    alert("Error al validar el archivo.");
    inputArchivo.value = "";
  }

  })
});
  function abrirModalAgregar() {
  document.getElementById('modalAgregar').classList.remove('hidden');
  document.getElementById('modalAgregar').classList.add('show');
}

function cerrarModalAgregar() {
  document.getElementById('modalAgregar').classList.remove('show');
  document.getElementById('modalAgregar').classList.add('hidden');
}

function abrirModalExcel() {
  document.getElementById('modalExcel').classList.remove('hidden');
  document.getElementById('modalExcel').classList.add('show');
}

function cerrarModalExcel() {
  document.getElementById('modalExcel').classList.remove('show');
  document.getElementById('modalExcel').classList.add('hidden');
}

function guardarProveedor() {
  const nombre = document.getElementById("nombreProveedor").value;
  const email = document.getElementById("emailProveedor").value;

  if (!nombre || !email) {
    alert("Completa ambos campos.");
    return;
  }
      const nuevoTercero = {
      nombre_tercero: nombre,
      email: email,
      cliente_id: 1
    };

    fetch("http://localhost:8000/terceros/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(nuevoTercero)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("Error al crear el tercero");
        
      }
      return response.json();
    })
    .then(data => {
      console.log("Tercero creado:", data);
      document.getElementById("mensajeExito").classList.remove("hidden");

      agregarTerceroTabla(data)



    })
    .catch(error => {
      console.error("Hubo un problema con la petici√≥n:", error);
    });

}

function subirExcel() {
  const archivo = document.getElementById("archivoExcel").files[0];
  if (!archivo) {
    alert("Seleccion√° un archivo Excel");
    return;
  }

  console.log("Subiendo archivo Excel:", archivo);
  // Aqu√≠ va tu l√≥gica para enviar con FormData
  cerrarModalExcel();
}








function agregarTerceroTabla(tercero) {
  const container = document.getElementById("proveedoresContainer");

  try {
    const row = document.createElement("tr");

    // Nombre del proveedor
    const nombreCell = document.createElement("td");
    nombreCell.textContent = tercero.nombre_tercero;

    // Email
    const emailCell = document.createElement("td");
    emailCell.innerHTML = `<i class="fas fa-envelope"></i> ${tercero.email}`;

    // Formulario asignado
    const formulariosCell = document.createElement("td");
    if (tercero.formulario_generado) {
      const icono = `<i class="fas fa-file-alt"></i> `;
      formulariosCell.innerHTML = icono + tercero.formulario_generado.nombre_formulario;
    } else {
      formulariosCell.innerHTML = `<em>No tiene formularios asignados</em>`;
    }

    // Agregar celdas a la fila
    row.appendChild(nombreCell);
    row.appendChild(emailCell);
    row.appendChild(formulariosCell);

    // Agregar la fila al cuerpo de la tabla
    container.appendChild(row);

  } catch (error) {
    console.error("Error al agregar el tercero:", error);
  }
}

document.getElementById('logoutBtn').addEventListener('click', function (e) {
  console.log('cerrar session')
  e.preventDefault();  // <--- importante si us√°s href
  localStorage.clear();
  window.location.href = '../../index.html';
});

</script>
</body>

</html>